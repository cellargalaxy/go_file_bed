<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>go_file_bed</title>
    <link type="text/css" rel="stylesheet" href="../css/bootstrap.min.css"/>
    <link type="text/css" rel="stylesheet" href="../css/bootstrap-vue.min.css"/>
</head>
<body>
<div class="container">
    <div id="login">
        <b-input-group size="sm">
            <b-form-input type="password" placeholder="secret" v-model="secret"></b-form-input>
            <b-form-input type="number" placeholder="tokenExp" v-model="tokenExp"></b-form-input>
            <b-button size="sm" variant="outline-primary" @click="login">login</b-button>
        </b-input-group>
    </div>

    <br/>

    <div id="add_file_form">
        <form>
            <b-input-group>
                <b-form-input size="sm" type="text" placeholder="sort" v-model="sort" @input="input"></b-form-input>
                <b-form-input size="sm" type="text" placeholder="date" v-model="date" @input="input"></b-form-input>
            </b-input-group>
            <b-input-group>
                <b-form-input size="sm" type="text" placeholder="filePath" v-model="filePath"></b-form-input>
                <b-button size="sm" variant="outline-primary" :disabled="loading" @click="uploads">upload</b-button>
            </b-input-group>
            <b-input-group>
                <b-form-file multiple size="sm" v-model="files" @input="input"></b-form-file>
            </b-input-group>
        </form>
    </div>

    <br/>

    <form id="uploadUrlForm">
        <b-input-group>
            <b-form-input size="sm" type="text" placeholder="sort" v-model="sort" @input="input"></b-form-input>
            <b-form-input size="sm" type="text" placeholder="date" v-model="date" @input="input"></b-form-input>
        </b-input-group>
        <b-input-group>
            <b-form-input size="sm" type="text" placeholder="filePath" v-model="filePath"></b-form-input>
            <b-button size="sm" variant="outline-primary" :disabled="loading" @click="uploads">upload</b-button>
        </b-input-group>
        <b-input-group>
            <b-form-textarea size="sm" placeholder="url" v-model="urls" :rows="row" @input="input"></b-form-textarea>
        </b-input-group>
    </form>
    <br/>
    <b-table id="lastFileInfoTable" stacked="xl" striped hover responsive small
             :fields="fields" :items="infos" :busy="loading">
        <template #cell(name)="data">
            <code>{{data.item.name}}</code>
        </template>
        <template #cell(md5)="data">
            <code>{{data.item.md5}}</code>
        </template>
        <template #cell(url)="data">
            <b-button-group>
                <b-button size="sm" variant="outline-success" @click="copyShort(data.item)">short</b-button>
                <b-button size="sm" variant="outline-primary" @click="copyLong(data.item)">long</b-button>
                <b-button size="sm" variant="outline-warning" @click="copyMarkdown(data.item)">markdown</b-button>
            </b-button-group>
        </template>
        <template #cell(deal)="data">
            <b-button-group>
                <b-button size="sm" variant="outline-success" @click="openFile(data.item.path)">open</b-button>
                <b-button size="sm" variant="outline-primary" :disabled="data.item.loading"
                          @click="info(data.item.path)">info
                </b-button>
                <b-button size="sm" variant="outline-danger" :disabled="data.item.loading"
                          @click="deleteFile(data.item.path)">delete
                </b-button>
            </b-button-group>
        </template>

        <template #table-busy>
            <div class="text-center text-primary">
                <b-spinner class="align-middle"></b-spinner>
                <strong>Loading...</strong>
            </div>
        </template>
    </b-table>

    <br/>

    <b-breadcrumb id="filePathBreadcrumb">
        <b-breadcrumb-item @click="go(-1)">
            <b-icon icon="house-fill"></b-icon>
        </b-breadcrumb-item>
        <b-breadcrumb-item v-for="(breadcrumb, index) in breadcrumbs" @click="go(index)">
            {{breadcrumb.name}}
        </b-breadcrumb-item>
    </b-breadcrumb>
    <b-table id="fileInfoTable" stacked="xl" striped hover responsive small
             :fields="fields" :items="infos" :busy="loading">
        <template #cell(name)="data">
            <code>{{data.item.name}}</code>
        </template>
        <template #cell(md5)="data">
            <code>{{data.item.md5}}</code>
        </template>
        <template #cell(url)="data">
            <b-button-group v-if="data.item.isFile">
                <b-button size="sm" variant="outline-success" @click="copyShort(data.item)">short</b-button>
                <b-button size="sm" variant="outline-primary" @click="copyLong(data.item)">long</b-button>
                <b-button size="sm" variant="outline-warning" @click="copyMarkdown(data.item)">markdown</b-button>
            </b-button-group>
        </template>
        <template #cell(deal)="data">
            <b-button-group>
                <b-button size="sm" variant="outline-success" @click="openFile(data.item.path)">open</b-button>
                <b-button size="sm" variant="outline-primary" :disabled="data.item.loading"
                          @click="info(data.item.path)">info
                </b-button>
                <b-button size="sm" variant="outline-danger" :disabled="data.item.loading"
                          @click="deleteFile(data.item.path)">delete
                </b-button>
            </b-button-group>
        </template>

        <template #table-busy>
            <div class="text-center text-primary">
                <b-spinner class="align-middle"></b-spinner>
                <strong>Loading...</strong>
            </div>
        </template>
    </b-table>


</div>
</body>
<script src="../js/vue.min.js"></script>
<script src="../js/bootstrap-vue.min.js"></script>
<script src="../js/bootstrap-vue-icons.min.js"></script>
<script src="../js/qs.min.js"></script>
<script src="../js/axios.min.js"></script>

<!-- 关于crypto-js的导入与使用：https://www.jianshu.com/p/90540249747d，https://github.com/kjur/jsrsasign/issues/232，https://stackoverflow.com/questions/57416217/cryptojs-encrypt-in-aes-256-cbc-returns-an-unexpected-value -->
<script src="../js/core.min.js"></script>
<script src="../js/enc-base64.min.js"></script>
<script src="../js/md5.min.js"></script>
<script src="../js/evpkdf.min.js"></script>
<script src="../js/jsrsasign-all-min.min.js"></script>

<script src="../js/util.js"></script>
<script src="../js/api.js"></script>

<script>
    window.onbeforeunload = (event) => 'maybe some data not save'

    let login_vue = new Vue({
        el: '#login',
        data: {
            secret: '',
            tokenExp: 3,
        },
        methods: {
            async login() {
                setSecret(this.secret)
                setTokenExp(this.tokenExp)
                let promise = ping()
                let data = await promise
                if (data !== null) {
                    alert('登录成功: ' + JSON.stringify(data))
                }
            },
            async logined() {
                let promise = ping()
                let data = await promise
                return data !== null
            },
        },
    })

    const add_file_form_vue = new Vue({
        el: '#add_file_form',
        data: {
            files: [],
            sort: '',
            date: formatDate(new Date(), 'YYYYMMDD'),
            filePath: null,
            loading: false
        },
        methods: {
            uploads() {
                if (this.files === undefined || this.files == null || this.files.length === 0) {
                    alert('还没有选择文件')
                    return
                }
                for (let i = 0; i < this.files.length; i++) {
                    if (this.files[i] === undefined || this.files[i] == null) {
                        continue
                    }
                    this.upload(this.files[i])
                }
            },
            upload(file) {
                if (file === undefined || file == null) {
                    alert('文件或为空')
                    return
                }
                const filePath = createFilePath(this.sort, this.date, file.name)
                if (filePath === undefined || filePath == null || filePath === '') {
                    alert('文件路径为空')
                    return
                }
                this.loading = true
                const param = new FormData()
                param.append("filePath", filePath)
                param.append("file", file)
                instance.post("admin/uploadFile", param, {headers: {'Content-Type': 'multipart/form-data'}})
                    .then(response => {
                        this.loading = false
                        const result = response.data
                        if (result.code === 1) {
                            this.init()
                            flush()
                        } else {
                            alert(result.message)
                        }
                    })
                    .catch(error => {
                        this.loading = false
                        alert("error: " + JSON.stringify(error))
                    })
            },
            input() {
                if (this.sort != null) {
                    this.sort = this.sort.replace(/\s/g, '');
                }
                if (this.files !== undefined && this.files != null && this.files.length > 0) {
                    this.filePath = createFilePath(this.sort, this.date, this.files[0].name)
                }
            },
            init() {
                this.files = []
                this.filePath = null
            }
        }
    })

    const uploadUrlVue = new Vue({
        el: '#uploadUrlForm',
        data: {
            urls: '',
            sort: '',
            date: formatDate(new Date(), 'YYYYMMDD'),
            filePath: null,
            loading: false
        },
        computed: {
            row() {
                let row = this.urls.split('\n').length
                row = row <= 0 ? 3 : row
                return row
            }
        },
        methods: {
            uploads() {
                if (this.urls === undefined || this.urls == null || this.urls === '') {
                    alert('URL为空')
                    return
                }
                const urls = this.urls.split('\n')
                for (let i = 0; i < urls.length; i++) {
                    if (urls[i] === undefined || urls[i] == null || urls[i] === '') {
                        continue
                    }
                    this.upload(urls[i])
                }
            },
            upload(url) {
                if (url === undefined || url == null || url === '') {
                    alert('URL为空')
                    return
                }
                let filename = url.split('//')
                filename = filename[filename.length - 1]
                filename = filename.split('?')
                filename = filename[0].replace(/:/g, '_').replace(/\//g, '-').replace(/\\/g, '-')
                const filePath = createFilePath(this.sort, this.date, filename)
                if (filePath === undefined || filePath == null || filePath === '') {
                    alert('文件路径为空')
                    return
                }
                this.loading = true
                instance.post("admin/uploadUrl", Qs.stringify({filePath: filePath, url: url}))
                    .then(response => {
                        this.loading = false
                        const result = response.data
                        if (result.code === 1) {
                            this.init()
                            flush()
                        } else {
                            alert(result.message)
                        }
                    })
                    .catch(error => {
                        this.loading = false
                        alert("error: " + JSON.stringify(error))
                    })
            },
            input() {
                if (this.sort != null) {
                    this.sort = this.sort.replace(/\s/g, '');
                }
                if (this.urls !== undefined && this.urls != null && this.urls !== '') {
                    this.urls = this.urls + '\n'

                    const url = this.urls.split('\n')[0]
                    let filename = url.split('//')
                    filename = filename[filename.length - 1]
                    filename = filename.split('?')
                    filename = filename[0].replace(/:/g, '_').replace(/\//g, '-').replace(/\\/g, '-')
                    this.filePath = createFilePath(this.sort, this.date, filename)
                }
            },
            init() {
                this.urls = ''
                this.filePath = null
            }
        }
    })

    const lastFileInfoVue = new Vue({
        el: '#lastFileInfoTable',
        data: {
            fields: [
                {key: 'name', label: 'name', sortable: true,},
                {key: 'size', label: 'size', sortable: true,},
                {key: 'count', label: 'count', sortable: true,},
                {key: 'md5', label: 'md5',},
                {key: 'url', label: 'url',},
                {key: 'deal', label: 'deal',},
            ],
            infos: [],
            loading: false,
        },
        methods: {
            listLastFileInfo() {
                this.loading = true
                instance.get("admin/listLastFileInfo", {params: {}})
                    .then(response => {
                        this.loading = false
                        const result = response.data
                        if (result.code === 1) {
                            if (result.data == null || result.data.length === 0) {
                                alert('没有最新文件')
                            }
                            this.infos = initFileInfos(result.data)
                        } else {
                            alert(result.message)
                        }
                    })
                    .catch(error => {
                        this.loading = false
                        alert("error: " + JSON.stringify(error))
                    })
            },
            openFile(path) {
                let index = 0
                for (; index < this.infos.length; index++) {
                    if (this.infos[index].path === path) {
                        break
                    }
                }
                if (index === this.infos.length) {
                    alert('非法打开文件的路径: ' + path)
                    return
                }
                if (this.infos[index].isFile) {
                    window.open(this.infos[index].url)
                } else {
                    alert('明明是最近文件，但居然是文件夹？！？')
                }
            },
            info(path) {
                let index = 0
                for (; index < this.infos.length; index++) {
                    if (this.infos[index].path === path) {
                        break
                    }
                }
                if (index === this.infos.length) {
                    alert('非法查询文件的路径: ' + path)
                    return
                }
                getFileCompleteInfo(this.infos, index)
            },
            deleteFile(path) {
                let index = 0
                for (; index < this.infos.length; index++) {
                    if (this.infos[index].path === path) {
                        break
                    }
                }
                if (index === this.infos.length) {
                    alert('非法删除文件的路径: ' + path)
                    return
                }
                removeFile(this.infos, index)
            },
            copyShort(file) {
                writeClipboard('/' + file.url)
            },
            copyLong(file) {
                let url = window.location.href
                if (!endsWith(url, '/')) {
                    url = url + '/'
                }
                writeClipboard(url + file.url)
            },
            copyMarkdown(file) {
                let url = window.location.href
                if (!endsWith(url, '/')) {
                    url = url + '/'
                }
                writeClipboard('![' + file.name + '](' + url + file.url + ')')
            },
        }
    })

    const filePathVue = new Vue({
        el: '#filePathBreadcrumb',
        data: {
            breadcrumbs: [],
        },
        methods: {
            go(index) {
                if (index === -1) {
                    fileInfoVue.init('/')
                    return
                }
                fileInfoVue.init(this.breadcrumbs[index].path)
            },
            init(path) {
                this.breadcrumbs = []
                const names = path.split('/')
                let filePath = ''
                for (let i = 0; i < names.length; i++) {
                    if (names[i] === '') {
                        continue
                    }
                    filePath = filePath + '/' + names[i]
                    this.breadcrumbs.push({name: names[i], path: filePath})
                }
            }
        }
    })

    const fileInfoVue = new Vue({
        el: '#fileInfoTable',
        data: {
            fields: [
                {key: 'name', label: 'name', sortable: true,},
                {key: 'size', label: 'size', sortable: true,},
                {key: 'count', label: 'count', sortable: true,},
                {key: 'md5', label: 'md5',},
                {key: 'url', label: 'url',},
                {key: 'deal', label: 'deal',},
            ],
            folderPath: '',
            infos: [],
            loading: false,
        },
        methods: {
            listFolderInfo() {
                this.loading = true
                instance.get("admin/listFolderInfo", {params: {folderPath: this.folderPath}})
                    .then(response => {
                        this.loading = false
                        const result = response.data
                        if (result.code === 1) {
                            if (result.data == null || result.data.length === 0) {
                                alert('此目录下没有文件')
                            }
                            this.infos = initFileInfos(result.data)
                            filePathVue.init(this.folderPath)
                        } else {
                            alert(result.message)
                        }
                    })
                    .catch(error => {
                        this.loading = false
                        alert("error: " + JSON.stringify(error))
                    })
            },
            init(path) {
                this.folderPath = path
                this.listFolderInfo()
            },
            openFile(path) {
                let index = 0
                for (; index < this.infos.length; index++) {
                    if (this.infos[index].path === path) {
                        break
                    }
                }
                if (index === this.infos.length) {
                    alert('非法打开文件的路径: ' + path)
                    return
                }
                if (this.infos[index].isFile) {
                    window.open(this.infos[index].url)
                } else {
                    this.init(this.infos[index].path)
                }
            },
            info(path) {
                let index = 0
                for (; index < this.infos.length; index++) {
                    if (this.infos[index].path === path) {
                        break
                    }
                }
                if (index === this.infos.length) {
                    alert('非法查询文件的路径: ' + path)
                    return
                }
                getFileCompleteInfo(this.infos, index)
            },
            deleteFile(path) {
                let index = 0
                for (; index < this.infos.length; index++) {
                    if (this.infos[index].path === path) {
                        break
                    }
                }
                if (index === this.infos.length) {
                    alert('非法删除文件的路径: ' + path)
                    return
                }
                removeFile(this.infos, index)
            },
            copyShort(file) {
                writeClipboard('/' + file.url)
            },
            copyLong(file) {
                let url = window.location.href
                if (!endsWith(url, '/')) {
                    url = url + '/'
                }
                writeClipboard(url + file.url)
            },
            copyMarkdown(file) {
                let url = window.location.href
                if (!endsWith(url, '/')) {
                    url = url + '/'
                }
                writeClipboard('![' + file.name + '](' + url + file.url + ')')
            },
        }
    })

    function removeFile(infos, index) {
        if (!infos[index].isFile) {
            alert("所删除不是文件")
            return
        }
        if (!confirm("确实删除文件？！？: " + infos[index].path)) {
            return
        }
        infos[index].loading = true
        instance.post("admin/removeFile", Qs.stringify({filePath: infos[index].path}))
            .then(response => {
                infos[index].loading = false
                const result = response.data
                alert(result.code === 1 ? '删除成功' : '删除失败')
                if (result.code === 1) {
                    flush()
                }
            })
            .catch(error => {
                infos[index].loading = false
                alert("error: " + JSON.stringify(error))
            })
    }

    function getFileCompleteInfo(infos, index) {
        infos[index].loading = true
        instance.get("admin/getFileCompleteInfo", {params: {fileOrFolderPath: infos[index].path}})
            .then(response => {
                infos[index].loading = false
                const result = response.data
                if (result.code === 1) {
                    const info = initFileInfo(result.data)
                    infos[index].size = info.size
                    infos[index].count = info.count
                    infos[index].md5 = info.md5
                } else {
                    alert(result.message)
                }
            })
            .catch(error => {
                infos[index].loading = false
                alert("error: " + JSON.stringify(error))
            })
    }

    function flush() {
        lastFileInfoVue.listLastFileInfo()
        fileInfoVue.listFolderInfo()
    }

    function initFileInfos(infos) {
        if (infos == null) {
            return []
        }
        for (let i = 0; i < infos.length; i++) {
            infos[i] = initFileInfo(infos[i])
        }
        return infos
    }

    function initFileInfo(info) {
        if (info == null) {
            return null
        }
        info.loading = false
        info.url = encodeURI(info.url)
        if (info.size !== undefined) {
            info.size = formatFileSize(info.size)
        }
        if (info.url.startsWith('/')) {
            info.url = info.url.substring(1)
        }
        return info
    }





    function createFilePath(sort, date, filename) {
        let filePath = filename
        if (date != null && date !== '') {
            filePath = date + '/' + filePath
        }
        if (sort != null && sort !== '') {
            filePath = sort + '/' + filePath
        }
        return filePath
    }





    function endsWith(string, end) {
        return string.substring(string.length - end.length) === end
    }

    if (loginFormVue.getLogin()) {
        flush()
    }
</script>
</html>